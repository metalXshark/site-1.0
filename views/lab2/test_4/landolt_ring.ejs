<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/public/css/style_test_4.css">
    <title>Document</title>
</head>
<body>
<div id="bg" class="bg_img">
    <div class="top">
        <a href="/test_4">
            <img class="icon_back" src="/public/img/back.png">
        </a>
        <a href="/login">
            <img class="icon_menu" src="/public/img/menu.png">
        </a>
    </div>
    <div id ='Tester' class="tester">
        <div id='Instruction' class="instruction text_instruction">
            Этот тест оценивает ваше внимание. Вам необходимо выбрать все кольца соответствующие с указаным.
        </div>
        <button id='Start_button' class="start_button" name="start" onclick="start_test()">Начать</button>
        <div id="Choosing_instruction" class="choosing_instruction text_choosing_instruction"></div>
        <div id="Choosing_img" class="choosing_instruction text_choosing_instruction" style="background-color: white; width: 5vh; height: 5vh; left: 48vw"></div>
        <div id='Timer' class="iteration">0s</div>
        <div id='Final Result' class="result"></div>
        <div id='Scene' class="scene" style="top: 6vh">
            <div class="cell" id="1" onclick="cell(1, 1)"><img src="/public/img/n.png" class="cell_img"></div>
            <div class="cell" id="2" onclick="cell(1, 2)"><img src="/public/img/n.png" class="cell_img"></div>
            <div class="cell" id="3" onclick="cell(1, 3)"><img src="/public/img/n.png" class="cell_img"></div>
            <div class="cell" id="4" onclick="cell(1, 4)"><img src="/public/img/n.png" class="cell_img"></div>
            <div class="cell" id="5" onclick="cell(1, 5)"><img src="/public/img/n.png" class="cell_img"></div>
            <div class="cell" id="6" onclick="cell(1, 6)"><img src="/public/img/n.png" class="cell_img"></div>
            <div class="cell" id="7" onclick="cell(1, 7)"><img src="/public/img/n.png" class="cell_img"></div>
            <div class="cell" id="8" onclick="cell(1, 8)"><img src="/public/img/n.png" class="cell_img"></div>
            <div class="cell" id="9" onclick="cell(2, 9)"><img src="/public/img/ne.png" class="cell_img"></div>
            <div class="cell" id="10" onclick="cell(2, 10)"><img src="/public/img/ne.png" class="cell_img"></div>
            <div class="cell" id="11" onclick="cell(2, 11)"><img src="/public/img/ne.png" class="cell_img"></div>
            <div class="cell" id="12" onclick="cell(2, 12)"><img src="/public/img/ne.png" class="cell_img"></div>
            <div class="cell" id="13" onclick="cell(2, 13)"><img src="/public/img/ne.png" class="cell_img"></div>
            <div class="cell" id="14" onclick="cell(2, 14)"><img src="/public/img/ne.png" class="cell_img"></div>
            <div class="cell" id="15" onclick="cell(2, 15)"><img src="/public/img/ne.png" class="cell_img"></div>
            <div class="cell" id="16" onclick="cell(2, 16)"><img src="/public/img/ne.png" class="cell_img"></div>
            <div class="cell" id="17" onclick="cell(3, 17)"><img src="/public/img/e.png" class="cell_img"></div>
            <div class="cell" id="18" onclick="cell(3, 18)"><img src="/public/img/e.png" class="cell_img"></div>
            <div class="cell" id="19" onclick="cell(3, 19)"><img src="/public/img/e.png" class="cell_img"></div>
            <div class="cell" id="20" onclick="cell(3, 20)"><img src="/public/img/e.png" class="cell_img"></div>
            <div class="cell" id="21" onclick="cell(3, 21)"><img src="/public/img/e.png" class="cell_img"></div>
            <div class="cell" id="22" onclick="cell(3, 22)"><img src="/public/img/e.png" class="cell_img"></div>
            <div class="cell" id="23" onclick="cell(3, 23)"><img src="/public/img/e.png" class="cell_img"></div>
            <div class="cell" id="24" onclick="cell(3, 24)"><img src="/public/img/e.png" class="cell_img"></div>
            <div class="cell" id="25" onclick="cell(4, 25)"><img src="/public/img/se.png" class="cell_img"></div>
            <div class="cell" id="26" onclick="cell(4, 26)"><img src="/public/img/se.png" class="cell_img"></div>
            <div class="cell" id="27" onclick="cell(4, 27)"><img src="/public/img/se.png" class="cell_img"></div>
            <div class="cell" id="28" onclick="cell(4, 28)"><img src="/public/img/se.png" class="cell_img"></div>
            <div class="cell" id="29" onclick="cell(4, 29)"><img src="/public/img/se.png" class="cell_img"></div>
            <div class="cell" id="30" onclick="cell(4, 30)"><img src="/public/img/se.png" class="cell_img"></div>
            <div class="cell" id="31" onclick="cell(4, 31)"><img src="/public/img/se.png" class="cell_img"></div>
            <div class="cell" id="32" onclick="cell(4, 32)"><img src="/public/img/se.png" class="cell_img"></div>
            <div class="cell" id="33" onclick="cell(5, 33)"><img src="/public/img/s.png" class="cell_img"></div>
            <div class="cell" id="34" onclick="cell(5, 34)"><img src="/public/img/s.png" class="cell_img"></div>
            <div class="cell" id="35" onclick="cell(5, 35)"><img src="/public/img/s.png" class="cell_img"></div>
            <div class="cell" id="36" onclick="cell(5, 36)"><img src="/public/img/s.png" class="cell_img"></div>
            <div class="cell" id="37" onclick="cell(5, 37)"><img src="/public/img/s.png" class="cell_img"></div>
            <div class="cell" id="38" onclick="cell(5, 38)"><img src="/public/img/s.png" class="cell_img"></div>
            <div class="cell" id="39" onclick="cell(5, 39)"><img src="/public/img/s.png" class="cell_img"></div>
            <div class="cell" id="40" onclick="cell(5, 40)"><img src="/public/img/s.png" class="cell_img"></div>
            <div class="cell" id="41" onclick="cell(6, 41)"><img src="/public/img/sw.png" class="cell_img"></div>
            <div class="cell" id="42" onclick="cell(6, 42)"><img src="/public/img/sw.png" class="cell_img"></div>
            <div class="cell" id="43" onclick="cell(6, 43)"><img src="/public/img/sw.png" class="cell_img"></div>
            <div class="cell" id="44" onclick="cell(6, 44)"><img src="/public/img/sw.png" class="cell_img"></div>
            <div class="cell" id="45" onclick="cell(6, 45)"><img src="/public/img/sw.png" class="cell_img"></div>
            <div class="cell" id="46" onclick="cell(6, 46)"><img src="/public/img/sw.png" class="cell_img"></div>
            <div class="cell" id="47" onclick="cell(6, 47)"><img src="/public/img/sw.png" class="cell_img"></div>
            <div class="cell" id="48" onclick="cell(6, 48)"><img src="/public/img/sw.png" class="cell_img"></div>
            <div class="cell" id="49" onclick="cell(7, 49)"><img src="/public/img/w.png" class="cell_img"></div>
            <div class="cell" id="50" onclick="cell(7, 50)"><img src="/public/img/w.png" class="cell_img"></div>
            <div class="cell" id="51" onclick="cell(7, 51)"><img src="/public/img/w.png" class="cell_img"></div>
            <div class="cell" id="52" onclick="cell(7, 52)"><img src="/public/img/w.png" class="cell_img"></div>
            <div class="cell" id="53" onclick="cell(7, 53)"><img src="/public/img/w.png" class="cell_img"></div>
            <div class="cell" id="54" onclick="cell(7, 54)"><img src="/public/img/w.png" class="cell_img"></div>
            <div class="cell" id="55" onclick="cell(7, 55)"><img src="/public/img/w.png" class="cell_img"></div>
            <div class="cell" id="56" onclick="cell(7, 56)"><img src="/public/img/w.png" class="cell_img"></div>
            <div class="cell" id="57" onclick="cell(8, 57)"><img src="/public/img/nw.png" class="cell_img"></div>
            <div class="cell" id="58" onclick="cell(8, 58)"><img src="/public/img/nw.png" class="cell_img"></div>
            <div class="cell" id="59" onclick="cell(8, 59)"><img src="/public/img/nw.png" class="cell_img"></div>
            <div class="cell" id="60" onclick="cell(8, 60)"><img src="/public/img/nw.png" class="cell_img"></div>
            <div class="cell" id="61" onclick="cell(8, 61)"><img src="/public/img/nw.png" class="cell_img"></div>
            <div class="cell" id="62" onclick="cell(8, 62)"><img src="/public/img/nw.png" class="cell_img"></div>
            <div class="cell" id="63" onclick="cell(8, 63)"><img src="/public/img/nw.png" class="cell_img"></div>
            <div class="cell" id="64" onclick="cell(8, 64)"><img src="/public/img/nw.png" class="cell_img"></div>
        </div>
        <button id='Finish_button' class="restart_button" name="finish" onclick="finish_test()" style="top: 8vh">Готово</button>
        <a href="/landolt_ring" class="restart_button" id='Retry'>Заново</a>
    </div>
</div>
<script>
    const globalContainer = document.getElementById('Tester');
    const REFRESH_INTERVAL = 3;
    const container = document.querySelector('.scene');
    const children = [...container.children];

    let isDuringTest = false;
    let timePassed = 0;
    let initTime = 0;
    const TOTAL_RINGS = 8;
    let randRing = Math.floor(Math.random()*8) + 1;
    const ringMap = new Map();
    ringMap.set(1, "n.png");
    ringMap.set(2, "ne.png");
    ringMap.set(3, "e.png");
    ringMap.set(4, "se.png");
    ringMap.set(5, "s.png");
    ringMap.set(6, "sw.png");
    ringMap.set(7, "w.png");
    ringMap.set(8, "nw.png");
    let correctChosen = [];
    let incorrectChosen = [];

    function shuffle(array) {
        let currentIndex = array.length,
            temporaryValue, randomIndex;

        // While there remain elements to shuffle...
        while (0 !== currentIndex) {

            // Pick a remaining element...
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex -= 1;

            // And swap it with the current element.
            temporaryValue = array[currentIndex];
            array[currentIndex] = array[randomIndex];
            array[randomIndex] = temporaryValue;
        }

        return array;
    }

    function start_test() {
        isDuringTest = true;
        document.getElementById('Timer').style.display = 'flex';
        document.getElementById('Instruction').style.display = 'none';
        document.getElementById('Choosing_instruction').style.display = 'block';
        document.getElementById('Choosing_img').style.display = 'block';
        document.getElementById('Choosing_instruction').innerHTML = 'Нажмите все кольца вида: ';
        document.getElementById('Choosing_img').innerHTML = `<img src="/public/img/` + ringMap.get(randRing) + `" class="cell_img">`;
        document.getElementById('Start_button').style.display = 'none';
        document.getElementById('Finish_button').style.display = 'block';
        document.getElementById('bg').style.background = 'black';
        document.getElementById('Scene').style.display = 'block';

        shuffle(children);
        for (const child of children) {
            container.appendChild(child);
        }
        initTime = new Date().getTime();
        let timer = setInterval(function() {

            let now = new Date().getTime();

            let distance = now - initTime;

            timePassed = distance/1000;

            document.getElementById("Timer").innerHTML = timePassed + "s";

            if (!isDuringTest) {
                clearInterval(timer);
            }

        }, REFRESH_INTERVAL);
    }


    function cell(val, id) {
        let cell = document.getElementById(id);
        if (correctChosen.includes(cell)) {
            correctChosen.splice(correctChosen.indexOf(cell), 1);
            cell.style.backgroundColor = "white";
        } else if (incorrectChosen.includes(cell)) {
            incorrectChosen.splice(incorrectChosen.indexOf(cell), 1);
            cell.style.backgroundColor = "white";
        } else {
            cell.style.backgroundColor = "gray";
            if (val === randRing) {
                correctChosen.push(cell);
            } else {
                incorrectChosen.push(cell);
            }
        }
    }

    function finish_test() {
        isDuringTest = false;
        document.getElementById('Choosing_img').style.display = 'none';
        document.getElementById('Choosing_instruction').style.display = 'none';
        document.getElementById('Final Result').style.display = 'block';
        document.getElementById('Final Result').innerHTML = "Вы верно выбрали " + correctChosen.length + " колец и ошибочно выбрали " + incorrectChosen.length + " колец" +
        "<br>Время выполнения: " + timePassed;
        document.getElementById('Timer').style.display = 'none';
        document.getElementById('Finish_button').style.display = 'none';

        for (let cell of correctChosen) {
            cell.style.backgroundColor = "green";
        }
        for (let cell of incorrectChosen) {
            cell.style.backgroundColor = "red";
        }
        for (let cell of children) {
            if (parseInt(cell.id) < (randRing*8) && parseInt(cell.id) > ((randRing-1)*8) && !correctChosen.includes(cell) && !incorrectChosen.includes(cell)) {
                cell.style.backgroundColor = "yellow";
            }
        }
        document.getElementById('Retry').style.top = '10vh';
        document.getElementById('Retry').style.display = 'block';
        sendUser(correctChosen.length, incorrectChosen.length, timePassed);
    }

    // Sends test results to server
    async function sendUser(correct, incorrect, time) {
        const response = await fetch("/result", {
            method: "POST",
            body: JSON.stringify({
                username: "Tom", // TODO
                test: "landolt_ring",
                correct: correct.toString(),
                incorrect: incorrect.toString(),
                time: time.toString()
            })
        });
        const responseText = await response.text();
        console.log(responseText);
    }

</script>
</body>
</html>