<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/public/css/style_test_4.css">
    <link href="/public/libs/itc-slider/itc-slider.css" rel="stylesheet">
    <script src="/public/libs/itc-slider/itc-slider.js" defer></script>
    <title>Компасы</title>
</head>
<body>
<div id="bg" class="bg_img">
    <div class="top">
        <a href="/tests_lab5">
            <img class="icon_back" src="/public/img/back.png">
        </a>
        <a href="/login">
            <img class="icon_menu" src="/public/img/menu.png">
        </a>
    </div>
    <div id ='Tester' class="tester">
        <div id='Instruction' class="instruction text_instruction">
            С помощью теста по методике "Компасы" оценивается способность к пространственному и логическому мышлению.
            Вам необходимо определить в какую сторону света указывает компас по риске.
        </div>
        <button id='Start_button' class="start_button" name="start" onclick="start_test()">Начать</button>
        <div id='Timer' class="iteration" style="position: sticky; top: 45px; margin-left: 89%">2m 30s</div>
        <div id='Final Result' class="result"></div>
        <div class="container container-compasses" id="container"></div>
        <button id='Finish_button' class="restart_button" name="finish" onclick="finish_test()" style="top: 5vh">Готово</button>
        <a href="/compasses_test" class="restart_button" id='Retry'>Заново</a>
    </div>
</div>
<script src="/public/libs/CookieManager.js"></script>
<script>
    const TRUE_RESULT = ['southeast', 'east', 'south', 'south', 'southeast', 'west', 'southwest', 'northeast', 'northeast', 'northwest',
                         'south', 'north', 'southeast', 'northwest', 'southeast', 'southeast', 'northwest', 'northeast', 'southeast', 'southwest',
                         'south', 'southwest', 'southwest', 'north', 'southwest', 'southeast', 'west', 'southwest', 'west', 'west',
                         'southeast', 'west', 'east', 'southeast', 'east', 'north', 'east', 'west', 'south', 'southeast',
                         'southwest', 'southwest', 'southeast', 'southeast', 'west', 'northwest', 'south', 'southwest', 'southwest', 'west'];

    const TEST_DURATION = (2 * 60 + 30) * 1000;
    const NUMBER_OF_COMPASSES = 25;

    let timer;

    let correctChosen = [];
    let incorrectChosen = [];

    function start_test() {
        document.getElementById('Timer').style.display = 'flex';
        document.getElementById('Instruction').style.display = 'none';
        document.getElementById('Start_button').style.display = 'none';
        document.getElementById('Finish_button').style.display = 'block';
        document.getElementById('bg').style.background = 'black';
        document.getElementById('container').style.display = 'block';

        generateItemCompass();

        setTimeout(finish_test, TEST_DURATION);

        let end = (new Date().getTime() + 1000) + TEST_DURATION;
        timer = setInterval(() => {
            let now = new Date().getTime();
            let distance = Math.floor((end - now) / 1000);
            document.getElementById("Timer").innerHTML = Math.floor(distance / 60) + "m " + distance % 60 + "s ";
        }, 1000);
    }

    function get_random_set() {
        let randomSet = new Set();
        while (randomSet.size < NUMBER_OF_COMPASSES) {
            randomSet.add(Math.floor(Math.random() * 50))
        }
        return randomSet;
    }

    function generateItemCompass() {
        let container = document.getElementById('container');
        let randomSet = get_random_set()
        for (let i of randomSet) {
            container.innerHTML += `
            <div class="itemCompass">
                <div class="answers">
                    <div class="butSideWorld" id="north_${i}" onclick="cell('north_${i}')">С</div>
                    <div class="butSideWorld" id="east_${i}" onclick="cell('east_${i}')">В</div>
                    <div class="butSideWorld" id="south_${i}" onclick="cell('south_${i}')">Ю</div>
                    <div class="butSideWorld" id="west_${i}" onclick="cell('west_${i}')">З</div>
                </div>
                <img style="width: 137px;" src="https://www.aviaknow.ru/img/compas/${i+1}.png">
                <div class="answers">
                    <div class="butSideWorld" id="northeast_${i}" onclick="cell('northeast_${i}')">СВ</div>
                    <div class="butSideWorld" id="southeast_${i}" onclick="cell('southeast_${i}')">ЮВ</div>
                    <div class="butSideWorld" id="southwest_${i}" onclick="cell('southwest_${i}')">ЮЗ</div>
                    <div class="butSideWorld" id="northwest_${i}" onclick="cell('northwest_${i}')">СЗ</div>
                </div>

            </div>`
        }
    }

    function cell(id) {
        let cell = document.getElementById(id);
        let num = id.split('_')[1];
        let val = id.split('_')[0];
        let flag = false;
        correctChosen.forEach(elem => {
            if (elem.id.split('_')[1] === num) {
                flag = true;
            }
        })
        incorrectChosen.forEach(elem => {
            if (elem.id.split('_')[1] === num) {
                flag = true;
            }
        })
        if (correctChosen.includes(cell)) {
            correctChosen.splice(incorrectChosen.indexOf(cell), 1);
            cell.style.backgroundColor = "white";
        } else if (incorrectChosen.includes(cell)) {
            incorrectChosen.splice(incorrectChosen.indexOf(cell), 1);
            cell.style.backgroundColor = "white";
        } else if (flag) {
            return;
        } else {
            cell.style.backgroundColor = "gray";
            if (val === TRUE_RESULT[num]) {
                correctChosen.push(cell);
            } else {
                incorrectChosen.push(cell);
            }
        }
    }

    function finish_test() {
        document.getElementById('Instruction').style.display = 'none';
        document.getElementById('Final Result').style.display = 'block';
        document.getElementById('Final Result').innerHTML = "Вы верно выбрали " +
            correctChosen.length + "/" + (correctChosen.length + incorrectChosen.length) + " направлений";
        document.getElementById('Finish_button').style.display = 'none';
        clearInterval(timer);
        document.getElementById('Timer').style.display = 'none';

        for (let cell of correctChosen) {
            cell.style.backgroundColor = "green";
        }
        for (let cell of incorrectChosen) {
            cell.style.backgroundColor = "red";
        }
        document.getElementById('Retry').style.top = '10vh';
        document.getElementById('Retry').style.display = 'block';
        window.scroll(0, 0)
        sendUser(correctChosen.length, incorrectChosen.length);
    }

    // Sends test results to server
    async function sendUser(correct, incorrect) {
        const response = await fetch("/result", {
            method: "POST",
            body: JSON.stringify({
                user_name: getCookie("login"),
                test_name: "compass",
                correct: correct.toString(),
                incorrect: incorrect.toString()
            })
        });
        const responseText = await response.text();
        console.log(responseText);
    }
</script>
</body>
</html>